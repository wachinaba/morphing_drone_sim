# 検証レポート（2026-01-05）

本レポートは、`morphing_drone_sim` における **URDF版モーフィング（`demo_04_hover_pd_urdf_morph`）**で発生した「モーフ途中の墜落」「10秒程度での発散」について、これまで実施した検証を **仮説 → 検証 → 結果 → 次の仮説** の形式でまとめたものです。

---

## 0. 前提（対象・用語・観測手段）

- **対象デモ**: `sim/demo/demo_04_hover_pd_urdf_morph.py`（URDFモーフ、サーボ追従、動的ミキサ、PD制御）
- **モーフ入力**: `phi/psi/theta`（`--phi-amp/--phi-freq` 等で時間変化）
- **観測**: CSVログ（`--log-csv ...`）に以下が含まれる
  - 状態: `x,y,z,vx,vy,vz`
  - 目標: `x_des,y_des`（円軌道/ホールド）
  - コマンド: `Fz_body`（※途中からworld-Z力に意味変更）, `tau_*_body`
  - 実現: `Fz_ach, tau_*_ach` + 誤差 `*_err`
  - ミキサ診断: `mix_mode, mix_saturated, omega2_max_eff` 等
  - モータ: `omega2_cmd_* , omega2_act_*`

---

## 1. 「URDF版が発散する」初期事象の切り分け

### 仮説 1-1: ミキサの飽和（`omega2_max`）でトルクが出せず破綻している

**検証**
- `omega2_max` を小さくして飽和をわざと誘発し、挙動・ログを確認。
- `MixResult` に `mix_mode`/`mix_saturated` を追加し、CSVに出力。

**結果**
- 飽和時に `mix_mode` が切替わること、残差（`res_*`）が増えることを確認。
- ただし、URDF版での破綻は「上限に張り付く飽和」だけでなく、別要因も混在していることが分かった（後述の“非負制約”）。

**次の仮説**
- 「飽和」には2種類ある：上限飽和ではなく **非負制約（負推力不可）**が原因では？

---

## 2. 「theta/phiなどのモーフ中にトルクが弱い」問題の判別

### 仮説 2-1: トルクが弱い原因は「ゲイン不足」ではなく「制約により出せない」

**検証**
- CSVに `tau_cmd` と `tau_ach`、および `tau_err` を追加して判別可能にする。
- `mix_saturated` と「境界張り付き（0 or max）」の頻度を確認。

**結果**
- “弱い”の正体は多くの場合 **要求に対して実現が追いつかない（`tau_err`増大）**で、さらにその前段として
  - `mix_mode` がフォールバックに落ちる
  - 一部ロータが `omega2_cmd=0` に張り付く
  が観測され、**制約によりトルクを出せないケースが主体**と判断できた。

**次の仮説**
- なぜ `omega2_cmd` が0に張り付くのか？  
  → pinv解が負を含み、0にクリップされている可能性（nonnegative allocation問題）。

---

## 3. 非負制約（negative → 0 clip）問題とPX4ライクな解法への移行

### 仮説 3-1: pinv（擬似逆）ベースでは、トルク要求によって負の推力が必要になり破綻する

**検証**
- T/W（推力重量比）で `omega2_max` を自動設定し「上限飽和」を避けても、`mix_saturated` が高いままかを確認。
- `logs/tw_diag.csv` を生成し、以下を集計:
  - `hit_max_rows`（上限張り付き）
  - `any_zero_rows`（0張り付き）

**結果**
- `hit_max_rows=0`（上限に当たっていない）にも関わらず `mix_saturated` が多発。
- `omega2_cmd` に0が混じる行が存在し、**負が必要な配分 → 0クリップ**が主要因と判定。

**次の仮説**
- PX4のように「制約付き配分（上下限・非負）＋逐次デサチュレーション」を実装すれば改善する。

### 仮説 3-2: PX4ライクな制約付きWLS + active-setで安定化する

**検証（実装）**
- `sim/control/mixer.py` に **bound付き重み付き最小二乗（WLS）**を追加し、active-setで反復:
  - 制約: \( \omega^2 \in [\omega^2_{min}, \omega^2_{max}] \)
  - `MixResult.mode = "desat"`（デサチュレーション）を追加
- 単体テスト: `sim/tests/test_mixer_desat.py` を追加（負が必要なケースでもbounded解）

**結果**
- ユニットテストは通過。
- URDF円軌道でも `mix_mode=desat` で安定に回ることを確認（少なくとも暴走値は抑制）。

**次の仮説**
- それでも長時間（~10s）で発散するという報告がある。  
  → ミキサの制約以外（モデル/制御目標/モーフ中の有効推力低下）が原因か？

---

## 4. URDFモーフ中の墜落（中盤で沈み込み→接地）の原因

### 仮説 4-1: 高度制御が「推力はbody z方向」前提で破綻している（モーフで推力方向が傾く）

**検証（実装）**
- `sim/control/attitude_pd.py` に `altitude_pd_Fz_world()` を追加し、URDF版は **world-Zの必要力**を計算する方式に変更。
- `demo_04` 側でアロケーション行列の1行目を差し替え:
  - 変更前: `A[0,i] = CT * n_body_i.z`（body基準）
  - 変更後: `A[0,i] = CT * (R_bw @ n_body_i).z`（world基準）

**結果**
- モーフで法線が傾いても、鉛直成分に基づく配分となり **“見積もりの破綻”は改善**。
- ただし、長時間発散は解消しなかった（次項の原因が残る）。

**次の仮説**
- 長時間発散は、モーフ中の姿勢制御（トルク）と、yaw軸のモデル不足が関係するのでは？

---

## 5. 「10秒程度で発散」問題の再現と原因特定

### 仮説 5-1: 長時間の発散は、トルク要求が過大で姿勢が倒れ、結果として鉛直成分が失われる

**検証**
- 報告条件に近い設定で **12秒 headless**を実施しCSV解析:

例（再現ログ生成）:
```bash
python -m sim.demo.demo_04_hover_pd_urdf_morph --seconds 12.0 \
  --phi-amp 25 --phi-freq 0.5 --morph-tau 0.08 --morph-rate 3.0 \
  --tw-ratio 4.0 --kp-att 0.6 --kd-att 0.08 \
  --log-csv logs/diverge_12s.csv --log-flush-every 1 --log-every 0
```

**結果**
- `z<0.1`（接地/墜落相当）が発生。
- その直前に `tau_cmd` が数 N·m レベルまで跳ね上がり、`tau_ach` が追従できない区間が存在。
- さらに決定的な現象として、墜落直前に **`omega2_cmd` が全て 0** になる区間が観測された（自由落下）。

**次の仮説**
- `omega2_cmd=0` は「最適化上そうなる」ではなく、**Fz行（A0）が負または異常**になっている可能性が高い。  
  つまり “機体が倒れ込み、ロータ法線のworld-Z成分が負” になっているのでは？

### 仮説 5-2: 根因は `CQ=0`（yaw反トルクなし）で、姿勢が長時間で崩れて倒れ込みやすい

**検証**
- `CQ=0` のまま、T/W増大（`--tw-ratio 6`）、モータ時定数短縮、ダンピング付与、トルククリップ等を試す。
- そのうえで、**`CQ` に小さな値を入れて再テスト**し、12秒で `z<0.1` が消えるかを見る。

**結果**
- `CQ=0` のままでは、チューニングを変えても **早期に `omega2_cmd=0` 区間→落下**が出るケースが残った。
- `CQ=0.05` を付与すると、同条件で **12秒 headless で `z<0.1` が発生しない**ことを確認。
  - ログ: `logs/diverge_12s_cq005.csv`（`min_z≈0.201`, `z<0.1: None`）

**結論（現時点の最有力原因）**
- **`CQ=0`（yaw反トルクなし）で姿勢が長期的に崩れやすく、倒れ込み→world-Z成分が失われる → “出せる鉛直推力”が消えて落下**  
  が、10秒程度での発散/墜落の主要因。

**次の仮説**
- `CQ` は“仮係数”として入れたが、実機相当の値に同定すれば、より一貫した挙動になる。

---

## 6. 対応策（現時点の推奨設定）

### 推奨（モーフ弱めなし、20秒GUI用）
```bash
python -m sim.demo.demo_04_hover_pd_urdf_morph --gui --seconds 20 \
  --phi-amp 25 --phi-freq 0.5 --morph-tau 0.08 --morph-rate 3.0 \
  --tw-ratio 4.0 --kp-att 0.6 --kd-att 0.08 \
  --CQ 0.05
```

- `CQ` の推奨レンジ（暫定）: **0.02〜0.1**

---

## 7. 追加したテスト/計測（再発防止）

### 7.1 スモークテスト（PyBullet headless実行）
- `sim/tests/test_sim_smoke.py`
  - `RUN_SIM_SMOKE=1` のときだけ実行
  - `demo_03` / `demo_04` を0.3秒回してCSV健全性（NaN/Infなし、非負、上限内）を確認

### 7.2 回帰テスト（円軌道追従）
- `sim/tests/test_sim_regression_circle.py`
  - `RUN_SIM_REGRESSION=1` のときだけ実行
  - 誤差（mean/max）と発散検知を実施
  - URDF版は `mix_saturated` が常時1になり得るため、**bound-hit ratio** を指標化

---

## 8. 次の仮説・次のタスク

### 次の仮説
- `CQ` を入れて安定化したが、係数は暫定。**実機相当の `CT/CQ` を同定**すれば、より意味のある制御・限界評価が可能。

### 次のタスク案
- **(A) CQ同定（簡易）**: 一定のyaw入力で角速度立ち上がりを観測し、`CQ` の概算レンジを決める
- **(B) 長時間（20s〜60s）モーフ回帰テスト**: `CQ>0` 前提の「モーフ中ホバー安定」をテスト化
- **(C) 指標の整備**: `omega2_cmd==0`（全ゼロ）イベントを異常としてログ/テストで検知




