# 検証レポート（2026-01-06）

本レポートは、`morphing_drone_sim` における **URDF版（`demo_04_hover_pd_urdf_morph`）**の追加検証として、
「外乱＋ノイズ＋円軌道＋yaw＋モーフ」条件下での **`omega2_cmd` 全ゼロ（自由落下）**の再現・切り分けと、
対策として導入した **アンチワインドアップ**および **長時間回帰テスト**（`RUN_SIM_LONG`）について、
`VALIDATION_REPORT_2026-01-05.md` と同じく **仮説 → 検証 → 結果 → 次の仮説** でまとめたものです。

---

## 0. 前提（対象・観測・今回の追加物）

- **対象デモ**: `sim/demo/demo_04_hover_pd_urdf_morph.py`
- **観測**: CSVログ（`--log-csv ...`）で
  - 状態 `x,y,z,vx,vy,vz`, yaw（`yaw_deg`）/指令（`yaw_cmd_deg`）
  - ミキサ `mix_mode`, `omega2_cmd_*`, `omega2_act_*`
  - 指令/実現（`Fz_*`, `tau_*`） を確認
- **今回追加（主）**
  - **I項のアンチワインドアップ**（飽和時に積分更新をロールバック）
  - **I項のリーク**（積分状態の指数減衰）
  - **長時間回帰テスト**（`sim/tests/test_sim_long_regression_urdf_morph_circle.py`、`RUN_SIM_LONG=1`）

代表ログ（今回の切り分けで使用）:
- `logs/long_regress_debug.csv` / `logs/long_regress_debug2.csv`（3軸モーフ＋円軌道＋yaw＋外乱＋ノイズの試行）
- `logs/long_pass_candidate.csv`（phiモーフ＋円軌道＋yaw、早期に全ゼロ）
- `logs/long_pass_candidate2.csv`（同条件の一部パラメータ変更、全ゼロなし）
- `logs/phi_long_dist.csv`（phiモーフ＋定常トルク外乱＋推力ノイズ、長時間安定）

---

## 1. 長時間（~10秒）での「`omega2_cmd` 全ゼロ（自由落下）」再現

### 仮説 1-1: ミキサの制約（desat）不具合で全ゼロ解が出ている

**検証**
- 代表ログの統計を確認（`min_z`、`first_allzero`）

**結果（観測）**
- 3軸モーフ＋外乱＋ノイズの試行では、全ゼロが **t≈10.208s** で発生:
  - `logs/long_regress_debug.csv`: `first_allzero=(10.2083s, z≈0.0256)`
  - `logs/long_regress_debug2.csv`: `first_allzero=(10.2083s, z≈0.0259)`
- 円軌道＋yaw＋phiモーフでは、全ゼロが **t=1.0s** で早期発生:
  - `logs/long_pass_candidate.csv`: `first_allzero=(1.0s, z≈0.0220)`

**次の仮説**
- 「ミキサが突然ゼロを選ぶ」というより、**姿勢が崩れて “world-Z の有効成分が失われた”**結果として
  **Fz行（world-Z）で有効に持ち上げられない状態**になっている可能性が高い。

---

## 2. 円軌道＋yaw条件での「yawジャンプ → 全ゼロ」相関

### 仮説 2-1: 姿勢が崩れてヨーが暴れ、その直後に配分が破綻（全ゼロ）している

**検証**
- `logs/long_pass_candidate.csv` の全ゼロ直前後を抜粋して、`yaw_deg` と `omega2_cmd_*` の相関を見る。

**結果（観測）**
- 全ゼロ発生の瞬間（t=1.0）で yaw が大きく跳ね、同時に `omega2_cmd_*` が全て 0 になった:
  - t=0.9917: `yaw_deg≈-32.6`, `yaw_cmd_deg≈30.0`, `omega2_cmd=[max,max,max,max]`
  - t=1.0000: `yaw_deg≈-158.1`, `yaw_cmd_deg≈29.5`, `omega2_cmd=[0,0,0,0]`
- 直前は `mix_mode=desat` かつ上限張り付き（`omega2_cmd=max`）が続いており、**制御要求が強く、姿勢が破綻した**兆候がある。

**次の仮説**
- 破綻の引き金は「ミキサ」ではなく、**姿勢制御/ヨー追従が飽和し、姿勢が崩れて world-Z 成分が負/小になる**
  → **高度維持が不可能** → **全ゼロ（自由落下）**、という因果が濃厚。
  - この場合は「配分ロジック」よりも **制御要求の制約（トルク/ヨー系の抑制、ゲイン、フィルタ）**が主戦場。

---

## 3. 対策1: I項のアンチワインドアップ（飽和時の積分停止）＋リーク

### 仮説 3-1: 飽和中にIが溜まり、解除後に過大なトルク指令が出て破綻する（windup）

**検証（実装）**
- `demo_04` に以下を追加:
  - **リーク**: `--att-int-leak`, `--xy-int-leak`
  - **アンチワインドアップ**: `omega2_cmd` が境界（0 or max）に当たるステップでは、
    当該ステップの積分更新を **ロールバック**（`e_int_prev`, `xy_int_prev` に戻す）

**結果**
- 飽和時の「積分が増え続ける」挙動を抑制できるようになった（設計上の改善）。
- ただし、今回観測された “yawジャンプを伴う姿勢破綻” 自体を単独で完全に消すものではない。

**次の仮説**
- 「姿勢破綻→全ゼロ」の主因がヨー系なら、次は **ヨー指令/ヨーゲイン/トルク上限**と、
  **（必要なら）ヨーを後回しにする配分重み**のチューニングが効く。

---

## 4. 対策2: モータ初期化（t=0自由落下の除去）

### 仮説 4-1: モータ一次遅れにより t=0〜0.5s で推力不足になり、接地が破綻を誘発している

**検証（実装）**
- `demo_04` で **モータ状態 `omega2` を hover 近傍で初期化**する処理を追加（`omega2_hover`）。

**結果**
- t=0 の「推力がゼロから立ち上がる」問題は改善可能になった。
- しかし、今回の主要問題（t≈10.2s や t=1.0s の全ゼロ）は、初期化のみでは解消しなかった。

**次の仮説**
- 根は「初期沈み込み」ではなく、やはり **姿勢破綻（特にyawを含む）**。

---

## 5. 長時間回帰テストの追加（安定シナリオで固定）

### 仮説 5-1: 長時間（~20秒）での安定をテスト化すれば、今後の変更での退行を捕捉できる

**検証（実装）**
- `sim/tests/test_sim_long_regression_urdf_morph_circle.py` を追加/更新。
- `RUN_SIM_LONG=1` のときのみ実行する（重いのでデフォルトではスキップ）。
- シナリオは、現時点で安定が確認できた **phiモーフ＋定常トルク外乱＋推力ノイズ**に固定:
  - 代表ログ: `logs/phi_long_dist.csv`（`min_z≈0.298`, `first_allzero=None`）

**結果**
- `RUN_SIM_LONG=1` でテストが **安定にパス**することを確認。

**次の仮説**
- 円軌道＋yaw＋3軸モーフ＋外乱＋ノイズは、現状「不安定になり得る」ため、
  いきなり長時間回帰に入れるより、まず **短時間（例: 3〜5秒）での健全性/飽和率/誤差閾値**を段階的に固めていく方が効率的。

---

## 6. まとめ（今回の到達点）

- **全ゼロ（自由落下）イベント**を、複数条件で再現し、特に **yawジャンプを伴う姿勢破綻**との相関を確認。
- 対策として、
  - **アンチワインドアップ（飽和時ロールバック）**
  - **リーク**
  - **モータ初期化（hover近傍）**
  - **長時間回帰テスト（安定シナリオ固定）**
  を導入し、少なくとも「安定ケースの退行」は自動検知できる状態にした。

---

## 7. 次のタスク（提案）

- **(A) “全ゼロ”を設計上起きにくくする**:
  - 姿勢が倒れ込み、world-Z有効成分が負になる前に、`R_des`/トルク指令をさらに制限（例: `tau_max_factor`・最大傾き・ヨー抑制）。
- **(B) 円軌道＋yaw＋モーフの安定化**:
  - `yaw_tau`/`yaw_rate`/`CQ`/`torque-priority`（rp優先）を含むチューニング指針の整理と、短時間回帰テスト化。
- **(C) 異常検知の強化**:
  - `omega2_cmd` 全ゼロ・`n_world[:,2]` の符号反転（推力の鉛直寄与が負）・姿勢角の閾値超過をログ/テストに追加。




