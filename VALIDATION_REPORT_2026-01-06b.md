# 検証レポート（2026-01-06b）

本レポートは、`morphing_drone_sim` の **URDF版**（`sim/demo/demo_04_hover_pd_urdf_morph.py`）に対して直近実施した
「`hz`（制御更新）と物理ステップの不整合による沈み込み/不安定の切り分け」
「world-Z配分の物理ガード」
「反転（`nz_sum<0`）に起因する `omega2_cmd` 全ゼロ（自由落下）の再現」
「短時間/長時間の回帰テスト整理」
を **仮説 → 検証 → 結果 → 次の仮説** の形式でまとめたものです。

---

## 0. 前提（対象・観測・今回の変更点）

- **対象デモ**: `sim/demo/demo_04_hover_pd_urdf_morph.py`
- **観測**: CSVログ（`--log-csv`）の時系列
  - 状態 `x,y,z,vx,vy,vz`
  - ミキサ `mix_mode`, `omega2_cmd_*`, `omega2_act_*`
  - 姿勢/幾何診断（今回追加）: `tilt_deg`, `nz_min`, `nz_sum`
- **今回の実装（要点）**
  - **`--physics-hz` の導入**（制御Hz `--hz` と物理ステップHzを分離）
  - **physics substep**（`substeps = round(dt_ctrl/dt_phys)`）で、物理側は細かく積分
  - **外力は各physics stepで再適用**（PyBulletは外力をstepごとにクリアするため）
  - **world-Z配分の物理ガード**: `n_world[:,2]` が負のロータは Fz行で 0 にクリップ（上向き寄与なし）
  - **診断CSV**: `nz_min`, `nz_sum`, `tilt_deg`

---

## 1. `hz` を下げるとホバーですら沈み込む（重大な退行）

### 仮説 1-1: `--hz` で `time_step` を直接変えているため、物理積分が荒くなり（+外力が保持されず）平均推力が不足している

**検証**
- 変更前の `--hz 120` ホバー（モーフなし）を実行し `min_z` を確認。

**結果（観測）**
- `logs/hover_hz120.csv`:
  - `min_z ≈ 0.02497`（開始 `z=0.3` から接地付近まで沈み込み）
  - `max_tilt ≈ 0.00069deg`（姿勢崩れではなく「純粋な推力積分/適用の問題」）

**次の仮説**
- 制御更新と物理ステップを分離し、物理は高レートで回しつつ制御は低レートでも成立させるべき。

---

## 2. 対策: `--physics-hz` + physics substep 化で `hz` 依存の沈み込みを解消

### 仮説 2-1: 物理は常に高レート（例: 240Hz）で回し、制御は `--hz` で間引けば沈み込みは消える

**検証（実装）**
- `demo_04` に `--physics-hz` を追加。
- `PyBulletEnv(time_step=dt_phys)` とし、制御周期 `dt` の中で `substeps` 回 step。
- さらに重要: **外力（推力/外乱）は各physics stepで再適用**する（PyBulletの仕様）。

**結果（観測）**
- `logs/hover_hz120_fixed.csv`（`--hz 120`、`--physics-hz 240` 相当）:
  - `min_z ≈ 0.29999999`（沈み込みが消失）

**結論**
- `hz` 依存の沈み込みは、制御の問題ではなく **「物理ステップと外力適用の扱い」**が原因だった。

---

## 3. 円軌道+yaw条件で `omega2_cmd` 全ゼロ（自由落下）が再発する

### 仮説 3-1: 今回の全ゼロは「沈み込み」ではなく「反転」により world-Z 寄与が負になった結果

**検証**
- 円軌道+yaw+phiモーフ（短時間）で再現し、`tilt_deg` と `nz_sum` を確認。

**結果（観測）**
- `logs/short_regress_new.csv`:
  - `first_allzero = (t≈0.5083s, z≈0.2933)`
  - `max_tilt ≈ 180deg`
  - `min_nz_sum ≈ -4.0`（4基のロータが概ね下向き）
- 全ゼロは「高度が低いから」ではなく、**機体が反転して world-Z 推力を作れない**ため発生。

**次の仮説**
- 反転自体を起こさないための制約（トルク/ヨー/傾き）と、反転しかけたら追従を捨てて復帰する安全制御が必要。

---

## 4. world-Z配分の物理ガード（Fz行の `n_z<0` を0にクリップ）

### 仮説 4-1: 反転時に `n_z<0` のままFzを解かせると、最適化が不自然な解（全ゼロ/境界張り付き）を誘発する

**検証（実装）**
- アロケーション行列の Fz 行に入る `n_z` は **負を許さない**（上向き寄与のみ）:
  - `n_world_for_fz[:,2] = max(0, n_world[:,2])`

**結果**
- 反転が起きた場合でも「上向き寄与が無い」ことを明示でき、ログで原因追跡が容易になった。
- ただし、**反転そのもの**を止める効果はない（反転すればFzは出ないため）。

---

## 5. 回帰テストの整理

### 仮説 5-1: “安定に通る回帰”と“未解決で落ちうる回帰”を分けると、開発が前進する

**検証（実装）**
- 安定シナリオの短時間回帰（URDF）:
  - `sim/tests/test_sim_regression_hover_phi_urdf_short.py`
  - `RUN_SIM_REGRESSION=1` で実行
  - `hz=physics-hz=240` を採用（制御/物理一致で再現性重視）
- 円軌道+yaw+phiモーフの短時間回帰:
  - `sim/tests/test_sim_regression_circle_yaw_urdf_short.py`
  - 現状は反転し得るので **`RUN_SIM_REGRESSION_CIRCLE=1` の opt-in** に変更

**結果**
- `RUN_SIM_REGRESSION=1` では安定回帰が通り、未解決ケースは明示的に opt-in になった。

---

## 6. まとめ（今回の到達点）

- `hz` を下げると沈む問題を、**physics substep（+外力再適用）**で解消。
- `omega2_cmd` 全ゼロの主要因が、短時間でも起きる **反転（`nz_sum<0`）**であることを、`tilt_deg`/`nz_sum` により定量化。
- 回帰テストを「安定ケース」と「未解決ケース」に分離し、退行検知と開発速度を両立する形に整理。

---

## 7. 次の仮説・次タスク

- **(A) 反転予防（制約）**
  - `tau_max_factor` の強化、`yaw` 追従の優先度低下（`torque-priority=rp` の徹底）、最大傾きの厳格化（`max-tilt-deg`）などで反転トリガを潰す。
- **(B) 反転しかけたら追従を捨てて復帰**
  - `tilt_deg`/`nz_sum` の閾値で **XY/yaw追従を停止し、レベル復帰モード**へ遷移（いわゆるfailsafe）。
- **(C) “円軌道+yaw” を回帰に戻す**
  - 反転が抑えられた段階で `RUN_SIM_REGRESSION_CIRCLE` を常時回帰へ昇格。




